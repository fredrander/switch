<html>
	<head>
		<style>
			img {
				max-width: 90%;
				max-height: 90%;
				margin-left: auto;
				margin-right: auto;
				display: block;
			}
			.ontext {
				font-size: 2em;
				color: #729fcf;
				font-family: Arial;
				text-shadow: #d6e3f1 0 0 2px;
				text-align: center;
				font-weight: bold;
			}
			.offtext {
				font-size: 2em;
				color: #f57900;
				font-family: Arial;
				text-shadow: #fab97a 0 0 2px;
				text-align: center;
				font-weight: bold;
			}
		</style>
	</head>
	<body style="background-color:#181818">
		<div style="width=100%; height=100%;">
			<img id="switchImg" src="" onclick="toggleSwitch()"/>
			<p id="switchTxt" class="ontext"></p>
		</div>
		<script>
			var onImg= "power_button_green.png";
			var offImg= "power_button_red.png";
			var timerOnImg= "power_button_blue.png";
			var timerOffImg= "power_button_orange.png";
			var mode = -1;
			var state = 0;
			var timeStr = "";
			var timeStrClass = "ontext";

			function currImg() {
				var result = "";
				if (mode == 1) {
					result = onImg;
				} else if (mode == 0) {
					result = offImg;
				} else if (mode == 2) {
					if (state == 1) {
						result = timerOnImg;
					} else if (state == 0) {
						result = timerOffImg;
					}
				}

				return result;
			}

			function toggleSwitch() {
				mode = (mode + 1) % 3;
				state = 2; // unknown on state
				document.getElementById("switchImg").src = currImg();
				reqSetSwitch(mode);
			}

			function rspSetSwitch() {
				reqGetSwitch();
			}

			function reqSetSwitch(mode) {
				var req = new XMLHttpRequest();
				req.addEventListener("load", rspSetSwitch);
				req.open("GET", "setswitch.php?mode=" + mode, true);
				req.send();
			}

			function isoDateTimeUtcStr2Date( utcDateTimeStr ) {
				var utcDateTime = new Date( utcDateTimeStr );
				return utcDateTime;
			}

			function isoDateTimeUtcStr2LocalTimeStr( utcDateTimeStr ) {
				var utcDateTime = new Date( utcDateTimeStr );
				return utcDateTime.toLocaleTimeString();
			}

			function rspGetSwitch() {
				// Example response:
				// SWITCH=TIMER;STATE=ON;SUNRISEACTIVE=FALSE;SUNRISESTART=2017-10-26T04:30:00;
				// SUNRISESTOP=2017-10-26T06:00:00;SUNSETACTIVE=TRUE;SUNSETSTART=2017-10-25T15:33:00;
				// SUNSETSTOP=2017-10-25T21:30:00
				rspStr = JSON.parse(this.responseText);
				// create dictonary 
				var rsp = rspStr.split( ";" );
				var rspDict = {};
				for ( i = 0; i < rsp.length; i++ ) {
					var rspKeyValue = rsp[ i ].split( "=" );
					if ( rspKeyValue.length > 1 ) {
						rspDict[ rspKeyValue[ 0 ] ] = rspKeyValue[ 1 ];
					}
				}

				timeStr = "";
				
				if ( rspDict[ "SWITCH" ] == "ON" ) {
					mode = 1;
					state = 1;
				} else if ( rspDict[ "SWITCH" ] == "OFF" ) {
					mode = 0;
					state = 0;
				} else if ( rspDict[ "SWITCH" ] == "TIMER" ) {
					mode = 2;
					if ( rspDict[ "STATE" ] == "ON" ) {
						timeStrClass = "ontext";
						state = 1;
						if ( rspDict[ "SUNRISEACTIVE" ] == "TRUE" ) {
							timeStr = isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNRISESTART" ] ) + 
							" - " +
							isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNRISESTOP" ] );
						} else if ( rspDict[ "SUNSETACTIVE" ] == "TRUE" ) {
							timeStr = isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNSETSTART" ] ) + 
							" - " +
							isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNSETSTOP" ] );
						}
					} else if ( rspDict[ "STATE" ] == "OFF" ) {
						timeStrClass = "offtext";
						state = 0;
						/*
						var nowUtc = new Date().getTime();
						var startSunrise = null;
						var startSunset = null;
						var comingPeriod = "";
						if ( "SUNRISEACTIVE" in rspDict ) {
							startSunrise = isoDateTimeUtcStr2Date( rspDict[ "SUNRISESTART" ] );
						}
						if ( "SUNSETACTIVE" in rspDict ) {
							startSunset = isoDateTimeUtcStr2Date( rspDict[ "SUNSETSTART" ] );
						}
						if ( startSunrise && startSunset && startSunrise >= nowUtc && startSunset >= nowUtc ) {
							if ( startSunrise < startSunset ) {
								comingPeriod = "SUNRISE";
							} else {
								comingPeriod = "SUNSET";
							}
						} else if ( startSunrise && startSunset ) {
							if ( startSunrise >= nowUtc ) {
								comingPeriod = "SUNRISE";
							} else {
								comingPeriod = "SUNSET";
							}
						} else if ( startSunrise && startSunrise >= nowUtc ) {
							comingPeriod = "SUNRISE";
						} else if ( startSunset && startSunset >= nowUtc ) {
							comingPeriod = "SUNSET";
						}

						if ( comingPeriod == "SUNRISE" ) {
							timeStr = isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNRISESTART" ] ) + 
							" - " +
							isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNRISESTOP" ] );
						} else if ( comingPeriod == "SUNSET" ) {
							timeStr = isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNSETSTART" ] ) + 
							" - " +
							isoDateTimeUtcStr2LocalTimeStr( rspDict[ "SUNSETSTOP" ] );
						}
						*/
					}
				}

				document.getElementById("switchImg").src = currImg();
				document.getElementById("switchTxt").className = timeStrClass;
				document.getElementById("switchTxt").innerHTML = timeStr;
			}

			function reqGetSwitch() {
				var req = new XMLHttpRequest();
				req.addEventListener("load", rspGetSwitch);
				req.open("GET", "getswitch.php", true);
				req.send();
			}
			
			window.onload=function() {
				reqGetSwitch();
				setInterval(reqGetSwitch, 5000);
			}
	
		</script>
	</body>

</html>

