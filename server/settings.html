<html>
	<head>
		<style>
			img {
				max-width: 90%;
				max-height: 90%;
				margin-left: auto;
				margin-right: auto;
				display: block;
			}
			.settingstext {
				font-size: 1em;
				color: #729fcf;
				font-family: Arial;
				text-align: left;
				font-weight: normal;
				line-height: 175%;
				margin-top: 2em;
				margin-left: 2em;
			}
			.buttonstyle {
				margin-left: 2em;
				background-color: #729fcf;
				border: none;
				padding: 4px 42px;
				color: black;
				font-weight: bold;
			}
			.buttonstyle:active {
				background-color: #8cc4ff;
			}
			input {
				color: black;
				background-color: lightgrey;
			}
			input::-webkit-outer-spin-button, 
			input::-webkit-inner-spin-button { margin-left: 10px; }
			input.timediff {
				width: 60px;
				text-align: right;
			}
			input.latlng {
				width: 100px;
			}
			.dbg {
				color: white;
			}
		</style>
	</head>
	<body style="background-color:#181818">
		<div style="width=100%; height=100%;">
			<form class="settingstext" id="settingsform">
				Enable timer:
				<input id="timerenable" type="checkbox"/>
				<br/>
				Period 1, start:
				<input id="timerstart_1" type="time"/>
				Stop:
				<input id="timerstop_1" type="time"/>
				Mon:
				<input id="timerdays_1_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_1_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_1_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_1_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_1_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_1_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_1_sun" type="checkbox"/>
				<br/>
				Period 2, start:
				<input id="timerstart_2" type="time"/>
				Stop:
				<input id="timerstop_2" type="time"/>
				Mon:
				<input id="timerdays_2_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_2_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_2_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_2_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_2_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_2_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_2_sun" type="checkbox"/>
				<br/>
				Period 3, start:
				<input id="timerstart_3" type="time"/>
				Stop:
				<input id="timerstop_3" type="time"/>
				Mon:
				<input id="timerdays_3_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_3_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_3_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_3_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_3_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_3_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_3_sun" type="checkbox"/>
				<br/>
				Period 4, start:
				<input id="timerstart_4" type="time"/>
				Stop:
				<input id="timerstop_4" type="time"/>
				Mon:
				<input id="timerdays_4_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_4_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_4_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_4_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_4_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_4_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_4_sun" type="checkbox"/>
				<br/>
				Period 5, start:
				<input id="timerstart_5" type="time"/>
				Stop:
				<input id="timerstop_5" type="time"/>
				Mon:
				<input id="timerdays_5_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_5_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_5_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_5_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_5_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_5_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_5_sun" type="checkbox"/>
				<br/>
				Period 6, start:
				<input id="timerstart_6" type="time"/>
				Stop:
				<input id="timerstop_6" type="time"/>
				Mon:
				<input id="timerdays_6_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_6_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_6_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_6_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_6_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_6_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_6_sun" type="checkbox"/>
				<br/>
				Period 7, start:
				<input id="timerstart_7" type="time"/>
				Stop:
				<input id="timerstop_7" type="time"/>
				Mon:
				<input id="timerdays_7_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_7_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_7_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_7_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_7_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_7_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_7_sun" type="checkbox"/>
				<br/>
				Period 8, start:
				<input id="timerstart_8" type="time"/>
				Stop:
				<input id="timerstop_8" type="time"/>
				Mon:
				<input id="timerdays_8_mon" type="checkbox"/>
				Tue:
				<input id="timerdays_8_tue" type="checkbox"/>
				Wed:
				<input id="timerdays_8_wed" type="checkbox"/>
				Thu:
				<input id="timerdays_8_thu" type="checkbox"/>
				Fri:
				<input id="timerdays_8_fri" type="checkbox"/>
				Sat:
				<input id="timerdays_8_sat" type="checkbox"/>
				Sun:
				<input id="timerdays_8_sun" type="checkbox"/>
				<br/>
				<br/>
				Enable timer at sunrise:
				<input id="sunriseenable" type="checkbox"/>
				<br/>
				Start at sunrise, Mon:
				<input id="sunrisestart_mon" type="time"/>
				Tue:
				<input id="sunrisestart_tue" type="time"/>
				Wed:
				<input id="sunrisestart_wed" type="time"/>
				Thu:
				<input id="sunrisestart_thu" type="time"/>
				Fri:
				<input id="sunrisestart_fri" type="time"/>
				Sat:
				<input id="sunrisestart_sat" type="time"/>
				Sun:
				<input id="sunrisestart_sun" type="time"/>
				<br/>
				Stop at sunrise - offset in minutes from sunrise:
				<input class="timediff" id="sunrisestop" type="number"/>
				<br/>
				<br/>
				Enable timer at sunset:
				<input id="sunsetenable" type="checkbox"/>
				<br/>
				Start at sunset - offset in minutes from sunset:
				<input class="timediff" id="sunsetstart" type="number"/>
				<br/>
				Stop at sunset, Mon:
				<input id="sunsetstop_mon" type="time"/>
				Tue:
				<input id="sunsetstop_tue" type="time"/>
				Wed:
				<input id="sunsetstop_wed" type="time"/>
				Thu:
				<input id="sunsetstop_thu" type="time"/>
				Fri:
				<input id="sunsetstop_fri" type="time"/>
				Sat:
				<input id="sunsetstop_sat" type="time"/>
				Sun:
				<input id="sunsetstop_sun" type="time"/>
				<br/>
				<br/>
				Time zone:
				<input id="timezone" type="text"/>
				<br/>
				Latitude:
				<input class="latlng" id="latitude" type="number" step="any"/>
				Longitude:
				<input class="latlng" id="longitude" type="number" step="any"/>
				<br/>
				<br/>
			</form>
			<button id="apply" class="buttonstyle" onclick="handleApply()">Apply</button>
			
			<p id="dbg" class="dbg"></p>
		</div>
		<script>
			var switchName = getSwitchName();
			var settingsDict = {};

			function getSwitchName() {
				var switchNameRegex = /.*\?s=(.*)$/g;
				var match = switchNameRegex.exec( window.location.href );
				return match[1];
			}

			function rspGetSettings() {
				rspStr = JSON.parse(this.responseText);

				var rsp = rspStr.split( "\n" );
				var currSection = "";
				for ( i = 0; i < rsp.length; i++ ) {

					if ( rsp[ i ].startsWith( "[" ) ) {
						
						var sectionSplit = rsp[ i ].split( "]" );
						if ( sectionSplit.length > 0 ) {
							currSection = sectionSplit[ 0 ].substring( 1 );
						}

					} else {
						
						var rspKeyValue = rsp[ i ].split( "=" );
						if ( rspKeyValue.length > 1 ) {
							var key = currSection + "_" + rspKeyValue[ 0 ].trim()
							var value = rspKeyValue[ 1 ].trim();
							settingsDict[ key ] = value;
						}
					}
				}

				document.getElementById("timerenable").checked = (settingsDict[ "timer_enabled" ] == "true");
				for ( i = 1; i < 9; i++ ) {
					document.getElementById("timerstart_" + i).value = settingsDict[ "timer_on_time_" + i ];
					document.getElementById("timerstop_" + i).value = settingsDict[ "timer_off_time_" + i ];
					document.getElementById("timerdays_" + i + "_mon").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 0) ) != 0;
					document.getElementById("timerdays_" + i + "_tue").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 1) ) != 0;
					document.getElementById("timerdays_" + i + "_wed").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 2) ) != 0;
					document.getElementById("timerdays_" + i + "_thu").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 3) ) != 0;
					document.getElementById("timerdays_" + i + "_fri").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 4) ) != 0;
					document.getElementById("timerdays_" + i + "_sat").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 5) ) != 0;
					document.getElementById("timerdays_" + i + "_sun").checked = ( parseInt(settingsDict[ "timer_days_" + i ]) & (1 << 6) ) != 0;
				}

				document.getElementById("sunriseenable").checked = (settingsDict[ "sunrise_enabled" ] == "true");
				document.getElementById("sunrisestart_mon").value = settingsDict[ "sunrise_on_time_mon" ];
				document.getElementById("sunrisestart_tue").value = settingsDict[ "sunrise_on_time_tue" ];
				document.getElementById("sunrisestart_wed").value = settingsDict[ "sunrise_on_time_wed" ];
				document.getElementById("sunrisestart_thu").value = settingsDict[ "sunrise_on_time_thu" ];
				document.getElementById("sunrisestart_fri").value = settingsDict[ "sunrise_on_time_fri" ];
				document.getElementById("sunrisestart_sat").value = settingsDict[ "sunrise_on_time_sat" ];
				document.getElementById("sunrisestart_sun").value = settingsDict[ "sunrise_on_time_sun" ];
				document.getElementById("sunrisestop").value = settingsDict[ "sunrise_off_diff_minutes" ];

				document.getElementById("sunsetenable").checked = (settingsDict[ "sunset_enabled" ] == "true");
				document.getElementById("sunsetstop_mon").value = settingsDict[ "sunset_off_time_mon" ];
				document.getElementById("sunsetstop_tue").value = settingsDict[ "sunset_off_time_tue" ];
				document.getElementById("sunsetstop_wed").value = settingsDict[ "sunset_off_time_wed" ];
				document.getElementById("sunsetstop_thu").value = settingsDict[ "sunset_off_time_thu" ];
				document.getElementById("sunsetstop_fri").value = settingsDict[ "sunset_off_time_fri" ];
				document.getElementById("sunsetstop_sat").value = settingsDict[ "sunset_off_time_sat" ];
				document.getElementById("sunsetstop_sun").value = settingsDict[ "sunset_off_time_sun" ];
				document.getElementById("sunsetstart").value = settingsDict[ "sunset_on_diff_minutes" ];
			
				document.getElementById("timezone").value = settingsDict[ "position_timezone" ];
				document.getElementById("latitude").value = settingsDict[ "position_latitude" ];
				document.getElementById("longitude").value = settingsDict[ "position_longitude" ];
			}

			function reqGetSettings() {
				var req = new XMLHttpRequest();
				req.addEventListener("load", rspGetSettings);
				req.open("GET", "getsettings.php?s=" + switchName, true);
				req.send();
			}

			function rspSetSettings() {
			}

			function handleApply() {

				if ( document.getElementById("timerenable").checked ) {
					settingsDict[ "timer_enabled" ] = "true";
				} else {
					settingsDict[ "timer_enabled" ] = "false";
				}
				for ( i = 1; i < 9; i++ ) {
					settingsDict[ "timer_on_time_" + i ] = document.getElementById("timerstart_" + i).value;
					settingsDict[ "timer_off_time_" + i ] = document.getElementById("timerstop_" + i).value;
					var days = 0;
					if ( document.getElementById("timerdays_" + i + "_mon").checked ) {
						days = days | (1 << 0);
					}
					if ( document.getElementById("timerdays_" + i + "_tue").checked ) {
						days = days | (1 << 1);
					}
					if ( document.getElementById("timerdays_" + i + "_wed").checked ) {
						days = days | (1 << 2);
					}
					if ( document.getElementById("timerdays_" + i + "_thu").checked ) {
						days = days | (1 << 3);
					}
					if ( document.getElementById("timerdays_" + i + "_fri").checked ) {
						days = days | (1 << 4);
					}
					if ( document.getElementById("timerdays_" + i + "_sat").checked ) {
						days = days | (1 << 5);
					}
					if ( document.getElementById("timerdays_" + i + "_sun").checked ) {
						days = days | (1 << 6);
					}
					settingsDict[ "timer_days_" + i ] = days.toString();
				}

				if ( document.getElementById("sunriseenable").checked ) {
					settingsDict[ "sunrise_enabled" ] = "true";
				} else {
					settingsDict[ "sunrise_enabled" ] = "false";
				}

				settingsDict[ "sunrise_on_time_mon" ] = document.getElementById("sunrisestart_mon").value;
				settingsDict[ "sunrise_on_time_tue" ] = document.getElementById("sunrisestart_tue").value;
				settingsDict[ "sunrise_on_time_wed" ] = document.getElementById("sunrisestart_wed").value;
				settingsDict[ "sunrise_on_time_thu" ] = document.getElementById("sunrisestart_thu").value;
				settingsDict[ "sunrise_on_time_fri" ] = document.getElementById("sunrisestart_fri").value;
				settingsDict[ "sunrise_on_time_sat" ] = document.getElementById("sunrisestart_sat").value;
				settingsDict[ "sunrise_on_time_sun" ] = document.getElementById("sunrisestart_sun").value;
				settingsDict[ "sunrise_off_diff_minutes" ] = document.getElementById("sunrisestop").value;

				if ( document.getElementById("sunsetenable").checked ) {
					settingsDict[ "sunset_enabled" ] = "true";
				} else {
					settingsDict[ "sunset_enabled" ] = "false";
				}

				settingsDict[ "sunset_off_time_mon" ] = document.getElementById("sunsetstop_mon").value;
				settingsDict[ "sunset_off_time_tue" ] = document.getElementById("sunsetstop_tue").value;
				settingsDict[ "sunset_off_time_wed" ] = document.getElementById("sunsetstop_wed").value;
				settingsDict[ "sunset_off_time_thu" ] = document.getElementById("sunsetstop_thu").value;
				settingsDict[ "sunset_off_time_fri" ] = document.getElementById("sunsetstop_fri").value;
				settingsDict[ "sunset_off_time_sat" ] = document.getElementById("sunsetstop_sat").value;
				settingsDict[ "sunset_off_time_sun" ] = document.getElementById("sunsetstop_sun").value;
				settingsDict[ "sunset_on_diff_minutes" ] = document.getElementById("sunsetstart").value;
			
				settingsDict[ "position_timezone" ] = document.getElementById("timezone").value;
				settingsDict[ "position_latitude" ] = document.getElementById("latitude").value;
				settingsDict[ "position_longitude" ] = document.getElementById("longitude").value;

				var postData = "s=" + switchName;
				postData += "&";
				postData += "settings=SETTINGS;"
				var section = "";
				for ( var key in settingsDict ) {
					if ( settingsDict.hasOwnProperty( key ) ) {
						var settingsSection = key.split("_", 1)[0];
						if ( settingsSection != section ) {
							section = settingsSection;
							postData += "[" + section + "]\n";
						}
						postData += key.substring( settingsSection.length + 1 );
						postData += "=";
						postData += settingsDict[ key ];
						postData += "\n";
					}
				}
				
				//document.getElementById("dbg").innerHTML = postData;

				var req = new XMLHttpRequest();
				req.addEventListener("load", rspSetSettings);
				req.open("POST", "setsettings.php", true);
				req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				req.send(postData);
			}
			
			window.onload=function() {
				reqGetSettings();
			}
		</script>
	</body>

</html>
